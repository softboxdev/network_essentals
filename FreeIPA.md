### Введение: Что такое FreeIPA?

Представьте себе, что у вас в организации много компьютеров (серверов и рабочих станций) и пользователей. Вам нужно, чтобы каждый пользователь мог заходить на любой разрешённый ему компьютер под одним и тем же логином и паролем. Вам нужно централизованно управлять правами доступа (кто и что может делать), политиками безопасности и сетевыми службами.

**FreeIPA (IPA - Identity, Policy, Audit)** — это как раз такой центральный "мозговой центр" или диспетчерская. Это открытый программный комплекс, который объединяет в себе:
*   **Службу каталогов** (как Active Directory от Microsoft, но на базе Linux) для хранения информации о пользователях, компьютерах, группах.
*   **Сервер аутентификации** (Kerberos) для безопасного "единого входа" (Single Sign-On).
*   **Сервер управления политиками доступа** (HBAC).
*   **Сервер управления правилами повышения привилегий** (Sudo).
*   **Встроенные службы** DNS, DDNS, NTP, а иногда и DHCP.

Проще говоря, FreeIPA создаёт **домен** — единое пространство доверия, где все участники (пользователи и компьютеры) знают друг друга и подчиняются общим правилам.

---

### 1. Архитектура, утилиты, средства создания и управления

#### Архитектура

*   **Домен FreeIPA**: Имеет уникальное имя, например, `example.local`.
*   **Серверы FreeIPA**:
    *   **IPA-мастер (Master)**: Главный сервер, на котором хранится вся информация и который обрабатывает все запросы. Для отказоустойчивости можно развернуть несколько мастер-реплик.
    *   **Реплика (Replica)**: Точная копия мастер-сервера. Она синхронизируется с ним и может принимать запросы на аутентификацию, распределяя нагрузку. Реплики критически важны для надёжности.
*   **Клиенты (Clients)**: Компьютеры (серверы или рабочие станции), которые "вступают" в домен FreeIPA. Они не хранят всю базу данных, но знают, как спросить у IPA-серверов: "А можно ли этому пользователю зайти? Какие у него права?".
*   **Узлы (Hosts)**: Любой компьютер, зарегистрированный в домене (и серверы, и клиенты).

#### Ключевые компоненты "под капотом"

*   **389 Directory Server**: Служба каталогов (база данных), где хранятся все объекты (пользователи, группы, хосты, политики).
*   **MIT Kerberos**: Система безопасной аутентификации. Вместо паролей по сети передаются специальные "билеты".
*   **SSSD (System Security Services Daemon)**: Демон, который работает на каждом клиенте. Он связывает локальную систему с центральным IPA-сервером, кэширует учётные данные и обеспечивает быстрый доступ.
*   **Certmonger**: Служба для управления SSL-сертификатами.

#### Утилиты управления

Управлять FreeIPA можно двумя основными способами:

1.  **Веб-интерфейс (Web UI)**: `https://<ipa-server-address>/ipa/ui`. Интуитивно понятный графический интерфейс для большинства операций.
2.  **Командная строка (CLI)**:
    *   `ipa`: Основная утилита. Имеет множество подкоманд:
        *   `ipa user-add` – добавить пользователя
        *   `ipa host-add` – добавить хост
        *   `ipa sudorule-add` – создать правило Sudo
    *   `kinit`: Получить билет Kerberos (войти в домен из командной строки). Пример: `kinit admin`.
    *   `klist`: Показать выданные билеты.

---

### 2. Установка и настройка. Особенности в Astra Linux SE

#### Общий процесс установки сервера

1.  **Подготовка**:
    *   Статический IP-адрес.
    *   Прописанное в `/etc/hosts` полное доменное имя (FQDN) сервера (например, `ipa01.example.local`).
    *   Время синхронизировано с точным источником (NTP).
    *   Открыты необходимые порты в firewall (если он включён): 80, 443, 389, 636, 88, 464 и др.

2.  **Установка пакетов**:
    ```bash
    sudo apt update && sudo apt install freeipa-server freeipa-server-dns
    ```

3.  **Запуск установки**:
    ```bash
    sudo ipa-server-install
    ```
    *   Скрипт задаст вопросы: доменное имя, имя realm (обычно то же, что и домен, но в верхнем регистре), пароль администратора `admin`, настроить ли встроенный DNS и т.д.

4.  **Настройка DNS**: Если вы используете встроенный DNS, нужно прописать серверы IPA в качестве DNS-серверов для всех клиентов.

#### Особенности в Astra Linux SE

Astra Linux — это российский дистрибутив с усиленными функциями безопасности, и он тесно интегрирован с FreeIPA.

*   **Предустановленные пакеты**: В Astra Linux часто пакеты FreeIPA идут в составе дистрибутива или легко устанавливаются из официальных репозиториев.
*   **Интеграция с PAM**: На клиентах Astra Linux используется своя, модифицированная схема настройки PAM (Pluggable Authentication Modules), которая уже "знает" о FreeIPA через SSSD.
*   **Утилита `astradm`**: Это специализированная утилита Astra Linux для управления системой, включая присоединение к домену. Хотя можно использовать и стандартный `ipa-client-install`, `astradm` может быть проще для новичков.
    *   Пример присоединения к домену через `astradm`:
        ```bash
        sudo astradm join --realm=EXAMPLE.LOCAL --server=ipa01.example.local
        ```
*   **Учёт мандатного контроля доступа (МКД)**: При настройке клиента Astra Linux с МКД (уровнем "А") система автоматически коррективает политики SELinux и настройки для корректной работы в домене FreeIPA. Это критически важно для соблюдения требований безопасности.

---

### 3. Управление безопасностью, мандатные атрибуты и параметры аудита

#### Управление безопасностью

*   **Учётные записи**: Централизованное управление паролями, блокировка учётных записей.
*   **Сервисные учётные записи**: Учётки для приложений, а не для людей.
*   **Политики паролей**: Можно задать сложность, историю, срок действия паролей.
*   **SSL/TLS сертификаты**: FreeIPA имеет встроенный Центр Сертификации (CA) для шифрования всего трафика внутри домена.

#### Мандатные атрибуты (Integrity Control / МКД)

FreeIPA позволяет хранить и управлять **мандатными атрибутами** уровня конфиденциальности (для СВТ) и уровня целостности (для Astra Linux). Это числовые или текстовые метки.

*   **Для пользователя** задаётся **уровень целостности (УЦ)**. Например, `0` (низкий), `100` (стандартный), `200` (высокий).
*   **Для файла, процесса или сеанса пользователя** также есть свой УЦ.

**Принцип**: Процесс (пользователь) может получить доступ к объекту (файлу), только если его УЦ **доминирует** (>=) над УЦ объекта. Пользователь с УЦ=100 не сможет прочитать файл с УЦ=200.

**В FreeIPA**:
*   Вы задаёте УЦ для пользователя в его учётной записи.
*   Когда пользователь входит в систему на клиенте Astra Linux, SSSD передаёт этот атрибут системе.
*   Система, используя механизмы мандатного контроля (например, `smack` или `lsm`), применяет эти правила.

#### Параметры аудита

FreeIPA позволяет централизованно управлять политиками аудита для клиентов Linux.

*   **Что это?** Политика аудита определяет, какие события (вход пользователя, запуск команды, доступ к файлу) должны записываться в журнал (`audit.log`).
*   **Где настраивается?** В веб-интерфейсе или через CLI: `ipa audticonfig-*` команды.
*   **Как работает?** Клиенты, присоединённые к домену, автоматически забирают эту политику и применяют её с помощью демона `auditd`.

---

### 4. Роли, пользователи, доменные группы, политики SUDO

#### Пользователи и группы

*   **Пользователь (User)**: Учётная запись человека или службы. Имеет логин, пароль, UID, GID, мандатный атрибут и др.
*   **Группа (Group)**: Коллекция пользователей или других групп. Используется для упрощения управления правами.
    *   **Позиционная группа (User Group)**: Обычная группа пользователей.
    *   **Доменная группа (Netgroup)**: Более старый, но мощный формат для определения групп хостов и пользователей. Часто используется в правилах HBAC и Sudo.

#### Роли (Roles) и Привилегии (Privileges)

Это механизм **ролевого доступа (RBAC)** для *администрирования* самого FreeIPA.

*   **Привилегия (Privilege)**: Набор разрешений на выполнение конкретных операций (например, "Добавить пользователя", "Сбросить пароль").
*   **Роль (Role)**: Набор привилегий. Пользователю или группе назначается роль, и они получают все права этой роли.
    *   **Примеры встроенных ролей**: `User Administrator` (может управлять пользователями), `Host Administrator` (может управлять компьютерами).

#### Политики SUDO

Политики Sudo определяют, **кто**, **на каких компьютерах**, **какие команды** может запускать с правами root (`sudo`).

*   **Создание правила**:
    1.  **Кто?** (User/Group/Hostgroup): Указываем пользователя или группу, которой даём право.
    2.  **На каких хостах?** (Host/Hostgroup/Netgroup): Указываем, на каких машинах это правило работает.
    3.  **Какие команды?** (Sudo Command): Список разрешённых команд (например, `/usr/bin/systemctl`).
    4.  **От имени кого?** (RunAs User): От имени какого пользователя можно запускать команду (обычно `root`).

*   **Пример через CLI**:
    ```bash
    ipa sudorule-add --hostcat=all --cmdcat=all AllCommandsRule
    ipa sudorule-add-user --groups=admins AllCommandsRule
    ```
    Это правило разрешает всем пользователям из группы `admins` выполнять любые команды на любых хостах.

---

### 5. Правила HBAC, управление доступом на основе узла

**HBAC (Host-Based Access Control)** — это правила, которые определяют, **какому пользователю/группе разрешён доступ на какой хост** и **через какой сервис** (например, ssh, login).

*   **Зачем это нужно?** Чтобы запретить пользователям вход на сервера, где им не положено работать. Даже если пароль верный, HBAC может заблокировать вход.

*   **Компоненты правила HBAC**:
    *   **Кто?** (User/Group)
    *   **Куда?** (Host/Hostgroup)
    *   **Через что?** (HBAC Service, например, `sshd`)

*   **Пример**: Создаём правило `allow_admins_to_webservers`, которое разрешает группе `sysadmins` доступ через службу `sshd` к группе хостов `webservers`.

*   **Важно**: По умолчанию после установки FreeIPA есть правило `allow_all`, которое разрешает всё. Для включения реального контроля его нужно **отключить**.

---

### 6. Создание взаимных доверительных отношений и общий доступ к ресурсам

#### Доверие с Active Directory (AD Trust)

FreeIPA может установить **доверительные отношения** с доменом Microsoft Active Directory. Это позволяет:

*   **Пользователям из AD** входить в системы, управляемые FreeIPA, используя свои AD-пароли.
*   Применять к ним политики HBAC и Sudo.

**Как это работает?**:
1.  На стороне FreeIPA настраивается "доверие" к домену AD.
2.  Создаётся специальный пользователь в AD, которому FreeIPA "доверяет".
3.  SSSD на клиентах FreeIPA может теперь аутентифицировать пользователей как из локальной базы FreeIPA, так и из доверенного домена AD.

#### Общий доступ к ресурсам

Сам FreeIPA не предоставляет общие папки (как Samba). Но он предоставляет **инфраструктуру** для них:

1.  **Аутентификация**: Пользователи проходят проверку через FreeIPA/Kerberos.
2.  **Авторизация**: Права на доступ к папке определяются владельцем файлового сервера на основе групп из FreeIPA.
3.  **Пример**: Сервер с Samba входит в домен FreeIPA. В настройках Samba-шары указывается: "разрешить доступ группе `department_finance`". Так как информация об этой группе хранится централизованно в FreeIPA, доступ будет работать для всех её членов.

---

### 7. Настройка и управление DNS, DDNS, DHCP и NTP

FreeIPA может быть центром не только для учётных записей, но и для сетевых служб.

#### DNS и DDNS

*   **DNS (Domain Name System)**: Преобразует имена (`client01.example.local`) в IP-адреса.
*   **DDNS (Dynamic DNS)**: Автоматически обновляет DNS-записи при изменении IP-адреса клиента.

**В FreeIPA**:
*   При установке сервера можно включить встроенный DNS.
*   Когда клиент присоединяется к домену, он автоматически регистрирует свою DNS-запись (DDNS) в зоне `example.local`.
*   Управление: через веб-интерфейс или команды `ipa dns*`.

#### DHCP

*   **DHCP (Dynamic Host Configuration Protocol)**: Автоматически выдаёт IP-адреса и настройки сети клиентам.
*   FreeIPA **сама не является DHCP-сервером**, но может с ним **интегрироваться**.
*   **Как?** DHCP-сервер (например, `isc-dhcp-server`) можно настроить на обновление DNS-записей через DDNS в FreeIPA. Для этого DHCP-серверу выдаются специальные учётные данные в FreeIPA.

#### NTP

*   **NTP (Network Time Protocol)**: Синхронизирует время на всех компьютерах сети.
*   **Критически важен** для работы Kerberos! Если время на клиенте и сервере расходится больше чем на ~5 минут, аутентификация перестанет работать.
*   **В FreeIPA**: Сервер IPA по умолчанию является источником времени (NTP-сервером) для всех клиентов. Клиенты автоматически настраиваются на синхронизацию с IPA-сервером при присоединении к домену.

### Заключение

FreeIPA — это мощный "комбайн", который превращает разрозненные Linux-системы в единую, безопасную и управляемую инфраструктуру. Начинайте с малого: установите один сервер, присоедините к нему тестовый клиент, создайте пользователя и поэкспериментируйте с политиками Sudo и HBAC. Понимание приходит с практикой. В контексте Astra Linux всегда помните о тесной интеграции и особенностях настройки мандатного контроля.

---

## 1. Настройка репликации серверов FreeIPA

Репликация нужна для **отказоустойчивости** и **балансировки нагрузки**. Если главный сервер (мастер) упадёт, реплика продолжит обслуживать запросы на аутентификацию и управление.

### Типы репликации

*   **CA-репликация**: Реплицируются данные Центра Сертификации.
*   **DNS-репликация**: Реплицируются зоны DNS.
*   **Data-репликация**: Реплицируются основные данные (пользователи, хосты, политики) через 389 Directory Server.

### Процесс настройки репликации

**Предварительные требования:**
1.  Время на обоих серверах синхронизировано (NTP).
2.  Имена хостов корректно разрешаются в DNS.
3.  Порты для репликации открыты в firewall (389, 443, 7389 и др.).

**Шаг 1: Настройка мастер-сервера**
На первом сервере обычно всё уже настроено. Убедитесь, что он полностью работоспособен.

**Шаг 2: Установка и настройка реплики**

На новом сервере (который станет репликой):

1.  **Установите пакеты IPA-клиента и сервера:**
    ```bash
    sudo apt update && sudo apt install freeipa-server freeipa-client
    ```

2.  **Присоедините сервер к домену как реплику:**
    Вам понадобится пароль администратора (`admin`) домена.
    ```bash
    sudo ipa-replica-install
    ```
    *   Скрипт запросит пароль администратора.
    *   Он автоматически найдёт мастер-сервер, скопирует все данные и настроит репликацию.
    *   Если используется встроенный DNS, реплика автоматически добавит себя в DNS-зону.

3.  **Проверка репликации:**
    *   На реплике выполните:
    ```bash
    sudo ipa-replica-manage list
    ```
    *   Создайте пользователя на мастер-сервере и проверьте, что он появился на реплике (и наоборот, если включена многомастерная репликация).

**Важно:** В Astra Linux процесс идентичен, но убедитесь, что используются пакеты из официальных репозиториев Astra.

---

## 2. Конфигурация сервисов с доменной аутентификацией FreeIPA

Общий принцип: сервис должен "доверять" FreeIPA для проверки учётных данных. Это реализуется через **Kerberos** (для единого входа) и **LDAP** (для поиска информации о пользователях/группах). Ключевой посредник — **SSSD**.

### Apache2 (веб-аутентификация)

Цель: защитить часть сайта паролем доменной учётной записи.

1.  **Установите модули:**
    ```bash
    sudo apt install libapache2-mod-auth-kerb libapache2-mod-authnz-pam
    ```

2.  **Создайте HTTP-ключ (keytab) для веб-сервера:**
    На IPA-сервере:
    ```bash
    ipa service-add HTTP/webserver.example.local
    ```
    Затем получите keytab и скопируйте его на веб-сервер:
    ```bash
    ipa-getkeytab -s ipa01.example.local -k /etc/apache2/auth/apache2.keytab -p HTTP/webserver.example.local
    ```

3.  **Настройте виртуальный хост Apache:**
    В конфиге сайта (`/etc/apache2/sites-available/my-secured-site.conf`):
    ```apache
    <Location /secured>
        AuthType Kerberos
        AuthName "FreeIPA Domain Login"
        KrbAuthRealms EXAMPLE.LOCAL
        KrbServiceName HTTP
        Krb5Keytab /etc/apache2/auth/apache2.keytab
        KrbMethodNegotiate on
        KrbMethodK5Passwd on

        # Использование PAM через mod_authnz_pam
        AuthBasicProvider PAM
        AuthPAMService apache

        Require valid-user
    </Location>
    ```

4.  **Настройте PAM:** В файле `/etc/pam.d/apache` добавьте строку:
    ```
    auth sufficient pam_sss.so
    account sufficient pam_sss.so
    ```

### Samba (файловый сервер)

Цель: сделать Samba-сервер членом домена и раздавать права на папки на основе доменных групп.

1.  **Установите Samba:**
    ```bash
    sudo apt install samba samba-common-bin
    ```

2.  **Присоедините сервер к домену FreeIPA:**
    ```bash
    sudo ipa-client-install --enable-dns-updates --mkhomedir
    ```

3.  **Настройте `/etc/samba/smb.conf`:**
    ```ini
    [global]
        workgroup = EXAMPLE
        realm = EXAMPLE.LOCAL
        security = ads
        dedicated keytab file = /etc/krb5.keytab
        kerberos method = secrets and keytab
        log file = /var/log/samba/log.%m
        idmap config * : backend = sss
        winbind use default domain = yes
        winbind offline logon = false

    [public_share]
        path = /srv/samba/share
        read only = no
        # Разрешить доступ доменной группе "users"
        valid users = @EXAMPLE.LOCAL\users
    ```

4.  **Перезапустите Samba:** `sudo systemctl restart smbd nmbd winbind`

### PostgreSQL

Цель: использовать доменные учётные записи для входа в СУБД.

1.  **Настройте PostgreSQL на использование PAM:**
    В `/etc/postgresql/*/main/pg_hba.conf` добавьте:
    ```
    host all all 192.168.1.0/24 pam pamservice=postgresql
    ```
    Создайте файл `/etc/pam.d/postgresql`:
    ```
    auth sufficient pam_sss.so
    account sufficient pam_sss.so
    ```

2.  **Создайте пользователей в PostgreSQL:**
    Подключитесь к БД и создайте роли с именами, совпадающими с доменными логинами.
    ```sql
    CREATE ROLE "ivanov" LOGIN;
    ```

### Exim + Dovecot (почтовый сервер)

Цель: аутентификация пользователей при отправке (SMTP, Exim) и получении (IMAP, Dovecot) почты через доменные учётные данные.

1.  **Установите почтовые сервисы:**
    ```bash
    sudo apt install exim4-daemon-heavy dovecot-imapd
    ```

2.  **Настройте Exim (SMTP) на аутентификацию:**
    В конфигурации Exim (`/etc/exim4/conf.d/auth/30_exim4-config_examples`):
    ```
    plain_server:
      driver = plaintext
      public_name = PLAIN
      server_condition = "${if pam{sss:${extract{1}{:}{$auth2}}{$auth3}}{1}{0}}"
      server_set_id = $auth2
      server_prompts = :
    ```

3.  **Настройте Dovecot (IMAP) на использование SSSD:**
    В `/etc/dovecot/conf.d/10-auth.conf`:
    ```
    auth_mechanisms = plain login
    !include auth-system.conf.ext
    ```
    В `/etc/dovecot/conf.d/auth-system.conf.ext`:
    ```
    passdb {
      driver = pam
      args = dovecot
    }
    userdb {
      driver = passwd
    }
    ```
    Создайте файл `/etc/pam.d/dovecot`:
    ```
    auth sufficient pam_sss.so
    account sufficient pam_sss.so
    ```

### SQUID (прокси-сервер)

Цель: разрешить доступ в интернет только аутентифицированным доменным пользователям.

1.  **Установите Squid:**
    ```bash
    sudo apt install squid
    ```

2.  **Настройте аутентификацию в `/etc/squid/squid.conf`:**
    ```
    auth_param basic program /usr/lib/squid/basic_pam_auth -P
    auth_param basic realm Squid proxy for EXAMPLE.LOCAL
    auth_param basic credentialsttl 2 hours
    acl authenticated proxy_auth REQUIRED
    http_access allow authenticated
    http_access deny all
    ```

---

## 3. Создание доверительных отношений с Microsoft AD

Это позволяет пользователям из домена AD входить в системы под управлением FreeIPA.

### Предварительные требования

*   Сетевая доступность между FreeIPA и AD-контроллерами.
*   Корректное разрешение имён в обе стороны.
*   Синхронизированное время.
*   Учётная запись с правами администратора домена в AD.

### Процесс настройки доверия

1.  **Настройте обратную зону DNS** для сети AD в DNS FreeIPA.

2.  **Настройте доверие со стороны FreeIPA:**
    ```bash
    sudo ipa trust-add --type=ad ad.example.com --admin Administrator --password
    ```
    *   Скрипт запросит пароль учётной записи `Administrator` домена AD.
    *   Он автоматически создаст все необходимые записи и настроит одностороннее доверие (AD -> FreeIPA).

3.  **Проверка:**
    *   Найдите пользователя из AD:
    ```bash
    ipa user-find --domain=ad.example.com
    ```
    *   Попробуйте войти на клиент FreeIPA, используя логин в формате `user@ad.example.com` и пароль из AD.

---

## 4. Резервное копирование и восстановление

### Резервное копирование

1.  **Data Backup (данные каталога):**
    ```bash
    sudo ipa-backup
    ```
    Создаёт папку с резервной копией в `/var/lib/ipa/backup/`.

2.  **Резервное копирование файлов конфигурации:**
    *   `/etc/ipa/` - основная конфигурация IPA.
    *   `/etc/sssd/sssd.conf` - конфигурация SSSD.
    *   `/etc/krb5.keytab` - ключи Kerberos.

3.  **Резервное копирование CA:**
    ```bash
    sudo ipa-cacert-manage backup
    ```

### Восстановление

1.  Остановите службы IPA: `sudo ipa-server-stop`
2.  Восстановите данные из бэкапа: `sudo ipa-restore /var/lib/ipa/backup/ipa-backup-...`
3.  Запустите службы IPA: `sudo ipa-server-start`
4.  Проверьте целостность данных: `ipa config-show --all`

---

## 5. Поиск и исправление ошибок. Нестандартные ситуации

### Логи для диагностики

*   **FreeIPA / Directory Server:** `/var/log/dirsrv/slapd-EXAMPLE-LOCAL/`
*   **Kerberos:** `/var/log/krb5kdc.log`
*   **Apache / Web UI:** `/var/log/httpd/error_log`
*   **SSSD (на клиентах):** `/var/log/sssd/`
*   **IPA-команды:** Добавляйте ключ `-v` для подробного вывода (`ipa user-show -v admin`).

### Частые проблемы и решения

1.  **"Клиент не может присоединиться к домену" (GSS-API Error)**
    *   **Причина:** Расхождение во времени (NTP), проблемы с DNS, закрытые порты.
    *   **Решение:** Проверьте `timedatectl status`, убедитесь, что `nslookup ipa01.example.local` и `nslookup 192.168.1.10` работают в обе стороны.

2.  **"Неверный пароль" при корректном вводе (KDC policy rejects)**
    *   **Причина:** Политика паролей в IPA не позволяет использовать текущий пароль пользователя AD (например, слишком простой).
    *   **Решение:** Настроить более мягкую политику паролей в IPA для доверенных пользователей или сменить пароль в AD.

3.  **Пользователи AD не видятся в `ipa user-find`**
    *   **Причина:** Доверие настроено, но синхронизация не произошла или есть проблемы с DNS.
    *   **Решение:** Используйте `ipa-adtrust-install --enable-compat` для включения совместимого слоя. Проверьте логи `sssd` на клиенте.

---

## 6. Лабораторные работы

### Лабораторная 1: Создание и настройка домена FreeIPA

**Цель:** Развернуть первый сервер FreeIPA и присоединить к нему клиент.

**Задачи:**
1.  Установите Astra Linux на две виртуальные машины (`ipa-srv01`, `client01`).
2.  На `ipa-srv01` задайте статический IP, FQDN (`ipa-srv01.lab.local`).
3.  Установите пакеты `freeipa-server freeipa-server-dns`.
4.  Запустите `ipa-server-install`, создав домен `lab.local` и realm `LAB.LOCAL`.
5.  На `client01` настройте DNS-сервер на `ipa-srv01`.
6.  Присоедините `client01` к домену с помощью `sudo ipa-client-install`.
7.  Проверьте: войдите на `client01` под учётной записью `admin`, созданной на сервере.

### Лабораторная 2: Настройка репликации и доверительных отношений

**Цель:** Создать отказоустойчивую инфраструктуру и настроить доверие между двумя доменами FreeIPA.

**Задачи:**
1.  Разверните третью ВМ (`ipa-srv02.lab.local`).
2.  Настройте репликацию с `ipa-srv01` на `ipa-srv02` с помощью `ipa-replica-install`.
3.  Создайте второй, независимый домен FreeIPA (`domain2.local`) на другой ВМ.
4.  Настройте двустороннее доверие между `lab.local` и `domain2.local` с помощью `ipa trust-add`.
5.  Проверьте: пользователь из `lab.local` должен иметь возможность войти на клиент, присоединённый к `domain2.local` (используя логин `user@lab.local`).

### Лабораторная 3: Настройка сервисов с доменной аутентификацией

**Цель:** Интегрировать ключевые сетевые сервисы с FreeIPA.

**Задачи:**
1.  На отдельной ВМ настройте **Apache2** для защиты каталога с помощью Kerberos-аутентификации.
2.  Настройте **Samba**-сервер, создайте общую папку и разрешите доступ только доменной группе `files_access`.
3.  Настройте **PostgreSQL** на аутентификацию через PAM/SSSD. Создайте БД и проверьте вход под доменной учётной записью.
4.  (Опционально, сложная) Настройте связку **Exim+Dovecot**.

### Лабораторная 4: Создание доверительных отношений с Microsoft AD

**Цель:** Интегрировать инфраструктуру Linux с существующим доменом Windows.

**Задачи:**
1.  Разверните ВМ с Windows Server и promoted её в контроллер домена (`ad.lab`, `AD.LAB`).
2.  Создайте в AD тестового пользователя.
3.  На FreeIPA-сервере (`ipa-srv01.lab.local`) настройте доверие к домену `ad.lab`.
4.  Проверьте:
    *   Поиск пользователя AD из FreeIPA: `ipa user-find --domain=ad.lab`.
    *   Вход на `client01` под учётной записью пользователя из AD (`user@ad.lab`).

Эти лабораторные работы дадут вам полное, практическое понимание построения комплексной инфраструктуры на основе FreeIPA.
